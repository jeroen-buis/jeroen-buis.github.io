<!doctype html>
<html class="no-js" lang="">
<head>
  <meta charset="utf-8">
  <title>Jeroen's test site</title>
  <meta name="description" content="Testing Glia scripts">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#fafafa">
  <style>
    /* ---------- DENSE THEME ---------- */
    :root{
      --base-font: 13px;
      --mono-font: 11.5px;
      --pad-xs: 4px;
      --pad-sm: 6px;
      --btn-radius: 6px;
    }
    * { box-sizing: border-box; }
    html body {
      margin: 0; background: #fff; height: 100%;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: var(--base-font); line-height: 1.25;
    }

    h1 { margin: 12px 16px; font-size: 18px; }
    #version { margin: 0 16px 6px; font-size: 11px; color: #666; }

    .toolbar { display:flex; gap: 8px; align-items:center; margin: 0 16px 6px; }
    .toolbar small { color:#666; }

    /* ---------- LAYOUT: 2/3 table + 1/3 attributes ---------- */
    .content {
      display: grid;
      grid-template-columns: 2fr 1fr; /* 2/3 + 1/3 */
      gap: 10px;
      margin: 0 16px 8px;
      align-items: start;
    }
    @media (max-width: 980px){ .content { grid-template-columns: 1fr; } }

    /* Table (dense) */
    .table-wrap { overflow-x:auto; }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      text-align: left; font-weight: 600;
      border-bottom: 1px solid #ddd;
      padding: var(--pad-xs) var(--pad-sm);
      background:#fafafa; font-size: 12px; white-space: nowrap;
    }
    tbody td {
      border-bottom: 1px solid #eee;
      padding: var(--pad-xs) var(--pad-sm);
      vertical-align: middle;
    }
    tbody tr:hover { background:#f9f9f9; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: var(--mono-font); }

    /* Status badges */
    .status { display:inline-block; padding: 1px 6px; border-radius: 999px; font-size: 11px; font-weight: 700; color:#fff; text-transform: capitalize; }
    .status-open { background:#17a34a; }
    .status-closed { background:#dc2626; }
    .status-unstaffed, .status-full { background:#ea580c; }
    .status-unknown { background:#6b7280; }

    /* Buttons */
    button { padding: 3px 8px; border: 1px solid #ddd; border-radius: var(--btn-radius); background:#fff; cursor:pointer; font-size: 12px; }
    button:hover { background:#f6f6f6; }
    button:disabled { opacity: .45; cursor: not-allowed; }
    .btn-row { display:flex; flex-wrap: wrap; gap: 4px; }

    /* Panel */
    .card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; background: #fff; }
    .card h2 { margin: 0 0 8px; font-size: 14px; }

    /* Attr rows */
    .attr-row { display: grid; grid-template-columns: 1fr 1fr auto; gap: 6px; margin-bottom: 6px; align-items: center; }
    .attr-row input { width: 100%; padding: 6px 8px; border:1px solid #d1d5db; border-radius: 6px; font-size: 12px; }
    .attr-row .remove { border-color:#f5d0d0; }
    .attr-row .remove:hover { background:#fee2e2; }
    .attr-actions { display:flex; gap:6px; margin-top: 6px; }
    .json-mini { margin-top: 8px; font-size: 11.5px; background:#0b1020; color:#e5e7eb; padding:8px; border-radius:8px; max-height:140px; overflow:auto; }

    /* Log */
    #log { margin: 0 16px 12px; padding: 8px; background:#f1f1f1; border:1px solid #ccc; height: 340px; overflow-y: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: var(--mono-font); }
    #log p { margin: 0 0 4px; }

    /* Modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; }
    .modal { width: min(900px, 92vw); max-height: 80vh; background:#fff; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,.25); display:flex; flex-direction:column; }
    .modal-header { display:flex; align-items:center; justify-content:space-between; padding: 8px 10px; border-bottom:1px solid #eee; }
    .modal-body { padding: 0 10px 10px; overflow:auto; }
    .modal-body pre { margin: 8px 0 0; padding:10px; background:#0b1020; color:#e5e7eb; border-radius:8px; font-size: 11.5px; }
    .modal-backdrop.show { display:flex; }

    /* Banner */
    .banner { margin: 0 16px 8px; padding: 8px 10px; border-radius:8px; background:#fff7ed; border:1px solid #fed7aa; display:none; align-items:center; gap:8px; }
    .banner.show { display:flex; }
    .banner strong { color:#9a3412; font-size: 12px; }
  </style>
</head>
<body>
  <h1>Welcome to Jeroen's test site!</h1>
  <div id="version">Version 1.6.0 (customAttributes)</div>

  <div class="toolbar">
    <button id="refreshBtn" type="button">Refresh queues</button>
    <button id="viewJsonBtn" type="button">View JSON</button>
    <span id="lastUpdated" style="margin-left:auto;"><small></small></span>
  </div>

  <div id="queueBanner" class="banner" role="status" aria-live="polite">
    <strong>Queued</strong>
    <span id="queueBannerText" class="mono"></span>
    <button id="cancelQueueBtn" type="button">Cancel</button>
  </div>

  <div class="content">
    <!-- Left: Queues table -->
    <div class="table-wrap">
      <table id="queuesTable" aria-label="Queues">
        <thead>
          <tr>
            <th>Queue Name</th>
            <th>Queue ID</th>
            <th>Status</th>
            <th>Medias</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Right: customAttributes panel -->
    <aside class="card">
      <h2>Custom Attributes</h2>
      <div id="attrsRows"></div>
      <div class="attr-actions">
        <button id="addAttrBtn" type="button">Add row</button>
        <button id="saveAttrsBtn" type="button">Save to Glia</button>
        <button id="resetAttrsBtn" type="button">Clear</button>
      </div>
      <pre id="attrsPreview" class="json-mini mono">{}</pre>
    </aside>
  </div>

  <!-- Log -->
  <div id="log"></div>

  <!-- Modal -->
  <div id="jsonModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="jsonTitle">
    <div class="modal">
      <div class="modal-header">
        <strong id="jsonTitle">Queues JSON</strong>
        <button id="closeJsonBtn" type="button" aria-label="Close">Close</button>
      </div>
      <div class="modal-body">
        <pre id="jsonDump" class="mono"></pre>
      </div>
    </div>
  </div>

  <!-- Glia script -->
  <script async
    src="https://api.beta.salemove.com/salemove_integration.js?site_id=4db6b3c1-cb7f-408d-9d8f-ef5d03c0f44b"
    onload="log('salemove_integration.js loaded'); initializeSalemove();">
  </script>

  <script>
    let gliaApi = null;
    let lastQueues = [];
    let queueTicket = null;
    let isEngaged = false;
    let visitorQueueState = 'UNKNOWN';
    let reenableTimer = null;

    const rowRefs = new Map(); // queueId -> refs
    const ATTRS_STORAGE_KEY = 'glia_custom_attributes_pairs_v1';

    /* ---------- utils ---------- */
    function log(message, data) {
      const logDiv = document.getElementById('log');
      const p = document.createElement('p');
      const suffix = data !== undefined ? ' ' + safeJson(data) : '';
      p.textContent = new Date().toISOString() + ': ' + message + suffix;
      logDiv.appendChild(p);
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    function safeJson(v) { try { return typeof v === 'string' ? v : JSON.stringify(v); } catch { return String(v); } }
    function formatMedias(arr) { if (!Array.isArray(arr) || !arr.length) return '–'; return arr.join(', '); }
    function statusClass(status) {
      switch ((status || '').toLowerCase()) {
        case 'open': return 'status status-open';
        case 'closed': return 'status status-closed';
        case 'unstaffed': return 'status status-unstaffed';
        case 'full': return 'status status-full';
        default: return 'status status-unknown';
      }
    }
    function setLastUpdated() {
      document.querySelector('#lastUpdated small').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
    }
    function showBanner(text) {
      const b = document.getElementById('queueBanner');
      document.getElementById('queueBannerText').textContent = text || '';
      b.classList.add('show');
    }
    function hideBanner() { document.getElementById('queueBanner').classList.remove('show'); }

    /* ---------- attributes panel (name/value rows) ---------- */
    function loadAttrPairs() {
      try { return JSON.parse(localStorage.getItem(ATTRS_STORAGE_KEY) || '[]'); }
      catch { return []; }
    }
    function saveAttrPairs(pairs) {
      localStorage.setItem(ATTRS_STORAGE_KEY, JSON.stringify(pairs || []));
    }
    function renderAttrRows(pairs) {
      const wrap = document.getElementById('attrsRows');
      wrap.innerHTML = '';
      (pairs.length ? pairs : [{name:'product', value:''}]).forEach((p,i) => addAttrRow(p.name, p.value));
      renderAttrsPreview();
    }
    function addAttrRow(name='', value='') {
      const wrap = document.getElementById('attrsRows');
      const row = document.createElement('div');
      row.className = 'attr-row';
      const nameInput = document.createElement('input');
      nameInput.placeholder = 'name (e.g. product)';
      nameInput.value = name;
      const valueInput = document.createElement('input');
      valueInput.placeholder = 'value';
      valueInput.value = value;
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'remove';
      removeBtn.textContent = '✕';
      removeBtn.title = 'Remove';
      removeBtn.addEventListener('click', () => { row.remove(); renderAttrsPreview(); persistAttrRows(); });
      [nameInput, valueInput].forEach(inp => inp.addEventListener('input', () => { renderAttrsPreview(); persistAttrRows(); }));
      row.appendChild(nameInput);
      row.appendChild(valueInput);
      row.appendChild(removeBtn);
      wrap.appendChild(row);
    }
    function readAttrPairsFromUI() {
      const rows = Array.from(document.querySelectorAll('#attrsRows .attr-row'));
      return rows.map(r => {
        const [nameEl, valueEl] = r.querySelectorAll('input');
        return { name: nameEl.value.trim(), value: valueEl.value.trim() };
      }).filter(p => p.name !== '');
    }
    function renderAttrsPreview() {
      const pairs = readAttrPairsFromUI();
      const obj = {};
      pairs.forEach(p => { if (p.name !== '') obj[p.name] = p.value; });
      document.getElementById('attrsPreview').textContent = JSON.stringify(obj, null, 2);
    }
    function persistAttrRows() {
      saveAttrPairs(readAttrPairsFromUI());
    }
    async function saveAttributesToGlia() {
      if (!gliaApi) { alert('Glia not ready'); return; }
      const pairs = readAttrPairsFromUI();
      const payload = {};
      pairs.forEach(p => { if (p.name !== '') payload[p.name] = p.value; });
      if (Object.keys(payload).length === 0) { log('No attributes to save'); return; }
      try {
        await gliaApi.updateInformation({
          customAttributesUpdateMethod: 'merge',
          customAttributes: payload
        });
        log('Saved customAttributes', payload);
        saveAttrPairs(pairs);
        renderAttrsPreview();
      } catch (err) {
        log('Failed to save attributes: ' + (err?.message || err));
        alert('Failed to save attributes: ' + (err?.message || err));
      }
    }
    function clearAttributes() {
      document.getElementById('attrsRows').innerHTML = '';
      addAttrRow('product','');
      persistAttrRows();
      renderAttrsPreview();
      log('Cleared custom attribute rows');
    }

    /* ---------- queue actions ---------- */
    function createActionButtons(q) {
      const container = document.createElement('div');
      container.className = 'btn-row';
      const allowed = new Set((q.state && Array.isArray(q.state.medias)) ? q.state.medias : []);
      const all = ['audio','phone','text','video','messaging'];
      const refs = {};
      all.forEach(m => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = labelForMedium(m);
        btn.disabled = !allowed.has(m) || !isQueueOpen(q);
        btn.addEventListener('click', () => queueForEngagement(q, m));
        container.appendChild(btn);
        refs[m] = btn;
      });
      return { node: container, buttons: refs };
    }
    function labelForMedium(m) {
      switch (m) {
        case 'audio': return 'Start Audio';
        case 'phone': return 'Start Phone';
        case 'text': return 'Start Chat';
        case 'video': return 'Start Video';
        case 'messaging': return 'Start Messaging';
        default: return 'Start ' + m;
      }
    }
    function isQueueOpen(q) { return q && q.state && String(q.state.status).toLowerCase() === 'open'; }
    async function queueForEngagement(q, medium) {
      if (!gliaApi) return;
      try {
        const opts = { queueId: q.id };
        if (medium === 'phone') {
          const num = window.prompt('Enter phone number (E.164, e.g. +11111111111):', '');
          if (!num) { log('Phone queuing canceled by user'); return; }
          opts.phoneNumber = num.trim();
        }
        log('Queueing for engagement...', { queue: q.name, medium });
        const ticket = await gliaApi.queueForEngagement(medium, opts);
        if (ticket && typeof ticket.cancel === 'function') queueTicket = ticket;
      } catch (err) {
        log('Failed to queue: ' + (err?.message || err));
        alert('Failed to queue: ' + (err?.message || err));
      }
    }
    function cancelQueuing() {
      try {
        if (queueTicket && typeof queueTicket.cancel === 'function') {
          queueTicket.cancel();
          log('Requested queue cancel');
        } else {
          log('No direct ticket handle; waiting for state to reflect cancellation');
        }
      } catch (e) { log('Cancel error: ' + (e?.message || e)); }
    }

    /* ---------- renderers ---------- */
    function renderTable(queues) {
      const tbody = document.querySelector('#queuesTable tbody');
      tbody.innerHTML = ''; rowRefs.clear();
      queues.slice().sort((a,b) => (a.name||'').localeCompare(b.name||'')).forEach(q => {
        const tr = document.createElement('tr');

        const tdName = document.createElement('td'); tdName.textContent = q.name || '(no name)'; tr.appendChild(tdName);
        const tdId = document.createElement('td'); tdId.className = 'mono'; tdId.textContent = q.id || ''; tr.appendChild(tdId);

        const tdStatus = document.createElement('td');
        const badge = document.createElement('span');
        const status = (q.state && q.state.status) ? q.state.status : 'unknown';
        badge.className = statusClass(status); badge.textContent = status; tdStatus.appendChild(badge); tr.appendChild(tdStatus);

        const tdMedias = document.createElement('td'); tdMedias.textContent = formatMedias(q.state && q.state.medias); tr.appendChild(tdMedias);

        const tdActions = document.createElement('td'); const actions = createActionButtons(q); tdActions.appendChild(actions.node); tr.appendChild(tdActions);

        tbody.appendChild(tr);
        rowRefs.set(q.id, { row: tr, statusBadge: badge, actionButtons: actions.buttons });
      });
      setLastUpdated();
      queues.forEach(updateRowFromQueueState);
    }
    function updateRowFromQueueState(q) {
      const ref = rowRefs.get(q.id); if (!ref) return;
      const status = (q.state && q.state.status) ? q.state.status : 'unknown';
      ref.statusBadge.className = statusClass(status); ref.statusBadge.textContent = status;
      const allowed = new Set((q.state && Array.isArray(q.state.medias)) ? q.state.medias : []);
      const open = isQueueOpen(q);
      const globallyBlocked = isEngaged || visitorQueueState === 'QUEUED';
      Object.entries(ref.actionButtons).forEach(([medium, btn]) => {
        btn.disabled = !open || !allowed.has(medium) || globallyBlocked;
      });
    }
    function renderJsonModal() { document.getElementById('jsonDump').textContent = JSON.stringify(lastQueues, null, 2); }
    function forceEnableAllRows() {
      lastQueues.forEach(q => {
        const ref = rowRefs.get(q.id); if (!ref) return;
        const allowed = new Set((q.state && Array.isArray(q.state.medias)) ? q.state.medias : []);
        const open = isQueueOpen(q);
        Object.entries(ref.actionButtons).forEach(([m, btn]) => { btn.disabled = !(open && allowed.has(m)); });
      });
      log('Force-enabled action buttons based on queue openness');
    }

    /* ---------- data flow ---------- */
    function refreshQueues() {
      if (!gliaApi) return Promise.resolve();
      return gliaApi.getQueues().then(queues => {
        lastQueues = queues || []; renderTable(lastQueues);
        log('Queues refreshed (' + lastQueues.length + ')');
        const ids = lastQueues.map(q => q.id);
        if (typeof gliaApi.subscribeToQueueStateUpdates === 'function') {
          gliaApi.subscribeToQueueStateUpdates(ids, onQueueState);
        }
      }).catch(err => { log('getQueues() failed: ' + (err && err.message ? err.message : err)); });
    }
    function onQueueState(queue) { updateRowFromQueueState(queue); }

    /* ---------- state listeners ---------- */
    function onVisitorQueueingState(queuingState) {
      try {
        const state = queuingState?.state || '';
        if (state === queuingState.QUEUE_STATES.QUEUED) {
          visitorQueueState = 'QUEUED'; queueTicket = queuingState.ticket || queueTicket;
          showBanner(`You are queued (reason: ${queuingState?.transitionReason || 'n/a'})`);
          rowRefs.forEach(ref => Object.values(ref.actionButtons).forEach(btn => btn.disabled = true));
        } else if (state === queuingState.QUEUE_STATES.CANNOT_QUEUE) {
          visitorQueueState = 'CANNOT_QUEUE'; queueTicket = null; hideBanner();
          lastQueues.forEach(updateRowFromQueueState);
        } else {
          visitorQueueState = 'CAN_QUEUE'; queueTicket = null; hideBanner();
          lastQueues.forEach(updateRowFromQueueState);
        }
      } catch (e) { log('Error handling visitor queueing state: ' + (e?.message || e)); }
    }
    function onEngagementStart(e) {
      isEngaged = true; log('ENGAGEMENT_START');
      rowRefs.forEach(ref => Object.values(ref.actionButtons).forEach(btn => btn.disabled = true));
    }
    function onEngagementEnd(e) {
      isEngaged = false; visitorQueueState = 'CAN_QUEUE'; queueTicket = null; hideBanner();
      log('ENGAGEMENT_END — enabling buttons and refreshing queues');
      if (reenableTimer) clearTimeout(reenableTimer);
      reenableTimer = setTimeout(async () => { await refreshQueues(); forceEnableAllRows(); setTimeout(forceEnableAllRows, 800); }, 300);
    }
    function attachGlobalListeners(glia) {
      glia.addEventListener(glia.EVENTS.QUEUE_STATE_UPDATE, onVisitorQueueingState);
      glia.addEventListener(glia.EVENTS.ENGAGEMENT_START, onEngagementStart);
      glia.addEventListener(glia.EVENTS.ENGAGEMENT_END, onEngagementEnd);
    }

    /* ---------- modal + DOM ---------- */
    function openJsonModal() { renderJsonModal(); document.getElementById('jsonModal').classList.add('show'); }
    function closeJsonModal() { document.getElementById('jsonModal').classList.remove('show'); }

    /* ---------- init ---------- */
    function initializeSalemove() {
      if (typeof sm !== 'undefined' && typeof sm.getApi === 'function') {
        sm.getApi({ version: 'v1' }).then(function(glia) {
          gliaApi = glia; log('Salemove API initialized.');
          attachGlobalListeners(glia);
          renderAttrRows(loadAttrPairs());
          refreshQueues();

          // example attribute to see something in logs on first load if you want
          glia.updateInformation({
            customAttributesUpdateMethod: 'merge',
            customAttributes: { vip: 'true' }
          }).then(() => log('Visitor info updated (customAttributes.vip=true).'))
            .catch(error => log('Error updating visitor info: ' + (error?.message || error)));
        }).catch(function(error) { log('Error initializing Salemove API: ' + error.message); });
      } else { log('Salemove API (sm object) not available.'); }
    }

    window.addEventListener('DOMContentLoaded', function() {
      log('Page fully loaded and DOM is ready.');
      // table controls
      document.getElementById('refreshBtn').addEventListener('click', refreshQueues);
      document.getElementById('viewJsonBtn').addEventListener('click', openJsonModal);
      document.getElementById('closeJsonBtn').addEventListener('click', closeJsonModal);
      document.getElementById('jsonModal').addEventListener('click', (e) => { if (e.target.id === 'jsonModal') closeJsonModal(); });
      window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeJsonModal(); });
      document.getElementById('cancelQueueBtn').addEventListener('click', cancelQueuing);

      // customAttributes panel
      document.getElementById('addAttrBtn').addEventListener('click', () => { addAttrRow('', ''); });
      document.getElementById('saveAttrsBtn').addEventListener('click', saveAttributesToGlia);
      document.getElementById('resetAttrsBtn').addEventListener('click', clearAttributes);
    });
  </script>
</body>
</html>
